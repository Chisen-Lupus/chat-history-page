\ProvidesPackage{chat-history}

\RequirePackage{xcolor}
\RequirePackage{graphicx}
\RequirePackage{tikz}
\RequirePackage{geometry}
\RequirePackage{calc} % Required for width calculations
\usetikzlibrary{fit}
\newlength{\textlen}

% Define geometry for the page
\geometry{a4paper,margin=1in}

% Define avatar and chat commands
\newcommand{\newchatperson}[4][]{%
    \expandafter\newcommand\csname #2\endcsname[1]{%
        % Measure the text width
        \settowidth{\textlen}{##1}
        
        \begin{tikzpicture}[baseline=(current bounding box.north)]
            % Avatar circle with inscribed image
            \begin{scope}
                \clip (0,0) circle(0.5cm); % Clip the avatar image to a circle
                \node[anchor=center,inner sep=0pt,minimum size=1cm] (avatar) at (0,0)
                {\includegraphics[width=1cm,height=1cm,keepaspectratio]{#3}};
            \end{scope}

            % Name positioned above the bubble and right of avatar
            \node[anchor=north west,text=gray] at (1.2,0.5) {\textbf{#4}};
            
            % Decide dynamically whether to use text width or not
            \ifdim\textlen>\dimexpr\textwidth-4cm\relax
                % Long text: use text width
                \node[anchor=north west,draw,rounded corners=0.2cm,fill={#1!20},
                text=black,align=left,inner sep=0.3em,
                text width={\dimexpr\textwidth-4cm\relax}] at (1.2,-0.2) {##1};
            \else
                % Short text: fit naturally
                \node[anchor=north west,draw,rounded corners=0.2cm,fill={#1!20},
                text=black,align=left,inner sep=0.3em] at (1.2,-0.2) {##1};
            \fi
        \end{tikzpicture}%%
        \par\vspace{1em} % Ensure line break after each bubble
    }
}

% Define context command
\newcommand{\context}[1]{%
    \begin{center}%
        \textcolor{gray}{\small --- #1 ---}%
    \end{center}%
}

% Define subsection style
\renewcommand{\subsection}[1]{%
    \par\vspace{1em}%
    \noindent\textbf{#1}\par\noindent\rule{\textwidth}{0.5pt}\vspace{0.5em}%
}

% No paragraph indentation
\setlength{\parindent}{0pt}

\endinput
