\ProvidesPackage{chat-history}

\RequirePackage[dvipsnames]{xcolor}
\RequirePackage{graphicx}
\RequirePackage{tikz}
\RequirePackage{calc} % Required for width calculations
\usetikzlibrary{fit}
\newlength{\textlen}

% Define avatar and chat commands
\newcommand{\newchatperson}[4][]{%
    \expandafter\newcommand\csname #2\endcsname[1]{%
        % Measure the text width
        \settowidth{\textlen}{##1}
        
        \makebox[\textwidth][l]{% Left-align the entire TikZ picture
        \begin{tikzpicture}[baseline=(current bounding box.north)]
            % Avatar circle with inscribed image
            \begin{scope}
                \clip (0,0) circle(0.6cm); % Clip the avatar image to a circle
                \node[anchor=center,inner sep=0pt,minimum size=1cm] (avatar) at (0,0)
                {\includegraphics[width=1.2cm,height=1.2cm,keepaspectratio]{#3}};
            \end{scope}

            % Name positioned above the bubble and right of avatar
            % \node[anchor=north west,text=gray] at (0.9,0.5) {\textbf{#4}};
            \node[anchor=north west,text=gray] at (0.9,0.5) {#4};
            
            % Decide dynamically whether to use text width or not
            \ifdim\textlen>\dimexpr\textwidth-4cm\relax
                % Long text: use text width
                % NOTE: 'draw' gives a border
                \node[anchor=north west,rounded corners=0.2cm,fill={#1!20},
                text=black,align=left,inner sep=0.7em,
                text width={\dimexpr\textwidth-4cm\relax}] at (0.9,-0.2) {##1};
            \else
                % Short text: fit naturally
                \node[anchor=north west,rounded corners=0.2cm,fill={#1!20},
                text=black,align=left,inner sep=0.7em] at (0.9,-0.2) {##1};
            \fi
        \end{tikzpicture}%%
        }
        \par\vspace{1em} % Ensure line break after each bubble
    }
}

% Define avatar and chat commands
\newcommand{\newchathost}[4][]{%
    \expandafter\newcommand\csname #2\endcsname[1]{%
        % Measure the text width
        \settowidth{\textlen}{##1}
        
        \makebox[\textwidth][r]{% Right-align the entire TikZ picture
        \begin{tikzpicture}[baseline=(current bounding box.north)]
            % Avatar circle with inscribed image
            \begin{scope}
                \clip (0,0) circle(0.6cm); % Clip the avatar image to a circle
                \node[anchor=center,inner sep=0pt,minimum size=1cm] (avatar) at (0,0)
                {\includegraphics[width=1.2cm,height=1.2cm,keepaspectratio]{#3}};
            \end{scope}

            % Name positioned above the bubble and left of avatar
            \node[anchor=north east,text=gray] at (-0.9,0.5) {{#4}};
            
            % Decide dynamically whether to use text width or not
            \ifdim\textlen>\dimexpr\textwidth-4cm\relax
                % Long text: use text width
                \node[anchor=north east,rounded corners=0.2cm,fill={#1!20},
                text=black,align=left,inner sep=0.7em,
                text width={\dimexpr\textwidth-4cm\relax}] at (-0.9,-0.2) {##1};
            \else
                % Short text: fit naturally
                \node[anchor=north east,rounded corners=0.2cm,fill={#1!20},
                text=black,align=left,inner sep=0.7em] at (-0.9,-0.2) {##1};
            \fi
        \end{tikzpicture}%
        }
        \par\vspace{1em} % Ensure line break after each bubble
    }
}

% Define context command
\newcommand{\context}[1]{%
    \vspace{1ex}
    \begin{center}%
        \textcolor{gray}{\small ------ #1 ------}%
    \end{center}%
    \vspace{-4ex}
}

% % Define subsection style
% \renewcommand{\subsection}[1]{%
%     \par\vspace{1em}%
%     \noindent\textbf{#1}\\[-0.5em] % Line break with negative vertical space to adjust spacing
%     \noindent\rule{\textwidth}{0.5pt}\vspace{0.5em}%
% }

% No paragraph indentation
\setlength{\parindent}{0pt}

\endinput
